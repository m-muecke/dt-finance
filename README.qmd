---
title: "data.table finance notes"
format: gfm
---

The goal of this document is to document common financial calculations using
the `data.table` package using the latest `R >= 4.4` and `data.table >= 1.16` syntax.

Load the required libraries:

```{r}
library(clock)
library(data.table)
library(ggplot2)
library(gt)
```

## Portfolio Management

#### Generate data

Generate some fake stock prices for a few tickers.

```{r}
set.seed(1994L)

generate_prices <- function(ticker, start_date, end_date) {
  dates <- seq.Date(as.Date(start_date), as.Date(end_date), by = "days")
  n <- length(dates)
  prices <- cumprod(1 + rnorm(n, mean = 0.0005, sd = 0.01)) * 100
  data.table(
    ticker = ticker,
    date = dates,
    price = prices
  )
}

generate_benchmark <- function(start_date, end_date) {
  dates <- seq.Date(as.Date(start_date), as.Date(end_date), by = "days")
  n <- length(dates)
  prices <- cumprod(1 + rnorm(n, mean = 0.0003, sd = 0.008)) * 3000
  data.table(
    ticker = "SP500",
    date = dates,
    price = prices
  )
}

ticker <- c("AAPL", "GOOGL", "MSFT", "AMZN")
start_date <- "2015-01-01"
end_date <- Sys.Date()

dt <- lapply(ticker, generate_prices, start_date, end_date) |> rbindlist()
weights <- data.table(
  ticker = ticker,
  weight = c(0.4, 0.3, 0.2, 0.1),
  country = c("USA", "USA", "USA", "USA")
)
dt <- dt[weights, on = "ticker"]
head(dt)
```

TODO: holdings table current date: name, total value, abs. and relative change in value (from start), relative weight
TODO: doughnut chart of portfolio composition

#### Calculate returns

```{r}
dt <- dt |>
  _[, market_value := price * weight] |>
  setorder(ticker, date) |>
  _[, ret := price / shift(price) - 1, by = ticker] |>
  na.omit("ret") |>
  _[, wret := ret * weight]
head(dt)
```

Alternatively, calculate the log returns:

```{r, eval = FALSE}
logret <- function(x){
  x <- log(x)
  x - shift(x)
}

dt <- dt |>
  setorder(ticker, date) |>
  _[, ret := logret(price), by = ticker] |>
  na.omit("ret") |>
  _[, wret := ret * weight]
head(dt)
```

```{r}
#| dpi = 300
dt |>
  _[date >= add_months(end_date, -12L), .(market_value = sum(market_value)), by = date] |>
  ggplot(aes(x = date, y = market_value)) +
  geom_line() +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major.y = element_line(color = "black", linewidth = 0.2),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(color = "black"),
    axis.title = element_blank()
  ) +
  labs(title = "Portfolio Value")
```

#### Calculate weekly, monthly and yearly returns

Return for each instrument:

```{r}
dt[, let(week = week(date), month = month(date), year = year(date))]
ret_week <- dt[, .(ret = prod(1 + ret) - 1), by = .(ticker, year, week)]
ret_month <- dt[, .(ret = prod(1 + ret) - 1), by = .(ticker, year, month)]
ret_year <- dt[, .(ret = prod(1 + ret) - 1), by = .(ticker, year)]
head(ret_year)
```

Return for the portfolio:

```{r}
port_ret_week <- dt[, .(ret = prod(1 + wret) - 1), by = .(year, week)]
port_ret_month <- dt[, .(ret = prod(1 + wret) - 1), by = .(year, month)]
port_ret_year <- dt[, .(ret = prod(1 + wret) - 1), by = year]
head(port_ret_year)
```

#### Compare performance with a benchmark

Calculat the benchmark return:

```{r}
bmr <- generate_benchmark(start_date, end_date) |>
  setorder(date) |>
  _[, ret := price / shift(price) - 1] |>
  na.omit("ret")

port <- dt |>
  _[, .(ret = prod(1 + wret) - 1, ticker = "Portfolio"), by = date] |>
  rbind(bmr[, .(ticker, date, ret)]) |>
  setorder(ticker, date) |>
  _[, cum_ret := cumprod(1 + ret) - 1, by = ticker] |>
  _[, ticker := fifelse(ticker == "Portfolio", ticker, "Benchmark")]
```

Compare the portfolio with the benchmark performance:

```{r}
#| dpi = 300
port |>
  _[date > "2021-01-01"] |>
  ggplot(aes(x = date, y = cum_ret, color = ticker)) +
  geom_line() +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major.y = element_line(color = "black", linewidth = 0.2),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(color = "black"),
    axis.title = element_blank(),
    legend.title = element_blank(),
    legend.position = "bottom"
  ) +
  scale_color_manual(values = c("Portfolio" = "darkblue", "Benchmark" = "black")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 2L)) +
  labs(title = "Cumulative Return: Portfolio vs. Benchmark")
```

Or turn it into a wide-format and display the performance as an area chart:

```{r}
#| dpi = 300
# TODO: remove the legend with T/F and bmr/port labels
perf <- port |>
  dcast(date ~ ticker, value.var = "cum_ret") |>
  setnames(tolower) |>
  _[, diff := portfolio - benchmark]

perf |>
  _[date > "2021-01-01"] |>
  ggplot(aes(x = date)) +
  geom_ribbon(aes(
      ymin = pmin(portfolio, benchmark),
      ymax = pmax(portfolio, benchmark),
      fill = diff > 0
    ),
    alpha = 0.4
  ) +
  geom_line(aes(y = portfolio), color = "darkblue") +
  geom_line(aes(y = benchmark), color = "black") +
  scale_fill_manual(values = c("TRUE" = "green", "FALSE" = "red")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 2L)) +
  labs(title = "Cumulative Return: Portfolio vs. Benchmark") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major.y = element_line(color = "black", linewidth = 0.2),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(color = "black"),
    axis.title = element_blank(),
    legend.title = element_blank(),
    legend.position = "none"
  )
```

```{r, eval = FALSE}
perf |>
  _[date >= "2022-01-10", .(
    benchmark = last(benchmark) - first(benchmark),
    portfolio = last(portfolio) - first(portfolio)
  ), by = .(year(date))] |>
  gt() |>
  fmt_markdown() |>
  tab_header(title = "Performance: Portfolio vs. Benchmark") |>
  fmt_percent(columns = c("benchmark", "portfolio")) |>
  cols_label(year = "Year", benchmark = "Benchmark", portfolio = "Portfolio")
```

#### Analyse the portfolio exposure

```{r}
```

#### Calculate volatility

```{r}
vola <- dt[, .(daily_vola = sd(ret)), by = .(ticker, year)] |>
  _[, let(
    weekly_vola = daily_vola * sqrt(5L),
    monthly_vola = daily_vola * sqrt(21L),
    yearly_vola = daily_vola * sqrt(252L)
  )]
head(vola)
```

#### TODO:

- Max/average drawdown
- Tacking error
- Portfolio risk
